## CPU性能优化总结篇
### CPU在做什么
1. 执行指令。
2. 上下文切换。
3. IO等待。
4. 执行内核代码如创建进程。
5. 处理中断。
### 当CPU在做这些事情的时候 表现是什么？
相同的表现是通过top可以看到系统总的CPU使用率较高。
1. 执行指令。通过pidstat可以看到，热点进程使用的CPU比较高。
2. 上下文切换。通过pidstat可以看到，热点进程使用率较高，并且专门针对热点进程可以发现热点进程的每秒上下文切换次数非常的高。
3. IO等待。通过top可以看到CPU使用率较高且主要使用在wait上，通过dstat可以看到系统总的读写频率较高，通过pidstat可以找到热点进程的读写频率非常的高。可通过设置打开文件时设置直接读写文件触发该现象。
4. 短时进程。这是一种特殊的情况，短时进程可能在做任何事情，如果感觉系统资源使用较多，但找不到是哪个进程在使用，可以往短时进程考虑。看是否有大量的进程创建，使用资源后又迅速死亡，可以使用的工具有execsnoop。
5. 处理中断。常见的可能会导致系统卡死的中断有网络中断。可以通过cat /proc/softirqs查看每个CPU每秒中断的次数。
### 番外--压测工具
1. stress。可以对CPU、IO、多线程、内存、磁盘等进行压测。通过stress可以模拟指令密集、高负载导致上下文切换。
2. hping3。可以模拟发送TCP请求，通过该工具可模拟频繁软中断的情况。
### 番外--如何优化性能
1. 问题定位。首先要知道无负载或者低负载的情况下，系统各项指标。压测时通过上述的工具列出系统的当前的各项指标，看哪一项指标异常。利用诸如perf之类的工具再进一步确认性能热点，确认当前进程主要在执行哪一块代码。
2. 解决问题。在问题定位过程中，记录各项指标，尤其是异常的指标。优化有问题的代码后，再次在相同的条件下进行测试，比较各项指标，尤其是之前表现异常的指标，是否有更好的表现。
### 总结
性能优化可以总结为一句话，找出CPU主要在做什么，它所作的事是否合法，是否有更优解。所有的工具都是为了这个目的而服务。至于深入的去学习如何性能优化，那就需要深入了解Linux系统，了解的越深入，代码编写和性能优化越顺手。